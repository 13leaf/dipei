/*! depei 2013-06-16 */
define(function(require,exports){function _load(api,data,success,error,complete){if("function"==typeof data)return arguments.callee(api,{},data,success,error);"string"==typeof data&&(data=LP.url2json(data));var ajaxConfig=_api[api];if(!ajaxConfig)return console&&console.error(api+" api is not exists!");var method=ajaxConfig.method||"";if(""==method){var res=/get/i.exec(api);method=res&&0==res.index?"GET":"POST"}else method=method.toUpperCase();error=error||ajaxConfig.error;var doAjax=function(){$.ajax({url:ajaxConfig.u,data:LP.mix(ajaxConfig.data||{},data),type:method,dataType:ajaxConfig.dataType||"json",cache:ajaxConfig.cache||!1,global:void 0===ajaxConfig.global?!0:ajaxConfig.global,error:error,complete:complete,timeout:ajaxConfig.timeout,success:function(e){e&&"string"==typeof e?success(e):_callback(e,api,success,error,ajaxConfig,doAjax)}})};ajaxConfig.needLogin===!0||ajaxConfig.needLogin!==!1&&"GET"!==method?_execAfterLogin(doAjax,api):doAjax()}function _callback(result,api,success,error,config,ajaxFn){if(result){var isAlertError=config.alertOnError,err_no=result.err_no;if(0!=err_no){if(isAlertError!==!1){if(err_no==_unloginErrorNum)return require.async("login",function(exports){exports.login(ajaxFn)}),void 0;LP.error(result.err_info||_api[api].m+"出错啦，请稍候重试...")}error&&error(result)}else success&&success(result);_needRefresh[api]&&(_needRefresh[api]=!1,setTimeout(function(){location.href=location.href.replace(/#.*/,"")},1e3))}}function _execAfterLogin(cb,api){LP.isLogin()?cb&&cb():(1!=_api[api].forceNoRefresh&&(_needRefresh[api]=!0),request.async("login",function(exports){exports.login(cb)}))}var $=require("jquery"),_api={login:{u:"/reg/login",m:_e("login")},reg:{u:"/reg/index",m:_e("sign up")}},_unloginErrorNum=-2,_needRefresh={};$(document).ajaxError(function(evt,xhr,ajaxOptions,thrownError){try{200==xhr.status||thrownError.match(/^Invalid JSON/)?LP.alert(" (*´Д｀*) 系统出错了。请反馈给我们。",3e3):""!==thrownError&&LP.alert("发生了未知的网络错误，请稍后重试。",3e3)}catch(e){}}),exports.ajax=_load});