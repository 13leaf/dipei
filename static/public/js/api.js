/*! depei 2013-07-09 */
define(function(require,exports){function _isFormatUrl(url){return!!/#\[.*\]/.test(url)}function _load(api,data,success,error,complete){if("function"==typeof data)return arguments.callee(api,{},data,success,error);"string"==typeof data&&(data=LP.url2json(data));var ajaxConfig=_api[api];if(!ajaxConfig)return console&&console.error(api+" api is not exists!");var method=ajaxConfig.method||"";if(""==method){var res=/get/i.exec(api);method=res&&0==res.index?"GET":"POST"}else method=method.toUpperCase();error=error||ajaxConfig.error,data=LP.mix(ajaxConfig.data||{},data);var doAjax=function(){$.ajax({url:_isFormatUrl(ajaxConfig.u)?LP.format(ajaxConfig.u,data):ajaxConfig.u,data:data,type:method,dataType:ajaxConfig.dataType||"json",cache:ajaxConfig.cache||!1,global:ajaxConfig.isAlertError===!1||ajaxConfig.global===!1?!1:!0,error:error,complete:complete,timeout:ajaxConfig.timeout,success:function(e){e&&"string"==typeof e?success(e):_callback(e,api,success,error,ajaxConfig,doAjax)}})};ajaxConfig.needLogin===!0||ajaxConfig.needLogin!==!1&&"GET"!==method?_execAfterLogin(doAjax,api):doAjax()}function _callback(result,api,success,error,config,ajaxFn){if(result){var isAlertError=config.alertOnError,error_no=result.err;if(0!=error_no){if(isAlertError!==!1){if(error_no==_unloginErrorNum)return require.async("login",function(exports){exports.login(ajaxFn)}),void 0;LP.error(result.msg||_api[api].m+_e("出错啦，请稍候重试..."))}error&&error(result.msg,result)}else success&&success(result);_needRefresh[api]&&(_needRefresh[api]=!1,setTimeout(function(){location.href=location.href.replace(/#.*/,"")},1e3))}}function _execAfterLogin(cb,api){LP.isLogin()?cb&&cb():(1!=_api[api].forceNoRefresh&&(_needRefresh[api]=!0),request.async("login",function(exports){exports.login(cb)}))}var $=require("jquery"),_api={login:{u:"/login/",m:_e("登录"),isAlertError:!1},logout:{u:"/login/logout/",m:_e("登出"),isAlertError:!1},reg:{u:"/reg/",m:_e("注册"),isAlertError:!1},locsug:{u:"/ajax/locSearch/k/#[k]",m:_e("检索地点"),isAlertError:!1},countrysug:{u:"/ajax/countrySearch/k/#[k]",m:_e("国家地点"),isAlertError:!1},saveProfile:{u:"/profile/setting/",m:_e("保存个人信息")},auth:{u:"/auth/",m:_e("乐陪认证")},corpimage:{u:"/image/crop/",data:{upFile:"",w:"",h:"",x:"",y:""},m:_e("裁剪图片")},upload:{u:"/image/upload/",data:{upFile:""},m:_e("上传图片")}},_unloginErrorNum=-2,_needRefresh={};$(document).ajaxError(function(evt,xhr,ajaxOptions,thrownError){try{200==xhr.status||thrownError.match(/^Invalid JSON/)?LP.alert(_e(" (*´Д｀*) 系统出错了。请反馈给我们。"),3e3):""!==thrownError&&LP.alert(_e("发生了未知的网络错误，请稍后重试。"),3e3)}catch(e){}}),exports.ajax=_load});