/*! depei 2013-07-11 */
define(function(require,exports){var $=require("jquery"),util=require("util"),_isFunction=LP.isFunction,_isString=LP.isString,_isCheckDom=(LP.isBoolean,function($dom){return $dom.length&&("checkbox"==$dom[0].type||"radio"==$dom[0].type)}),_mix=LP.mix,_config={event:"blur",tipDom:"",focusMsg:"",delay:"",requireMsg:"",maxLength:"",maxLengthMsg:"",minLength:"",minLengthMsg:"",lengthMsg:"",lengthType:"word",ignore:function(){},regexps:[],requireCheckNum:1,syncQueue:[],callBacks:[]},REGEXP={telephone:function(value){return GZ.isTelephone(value)},telephoneOrLandline:function(value){return/^[0-9\-\(\)]+$/.test(value)},email:function(value){return GZ.isEmail(value)},number:function(value){return/(^\d+$)|(^\d+\.\d+$)/.test(value)}},Validator=function(name,config){this.status=0,this.error="",this.name=name,this.$dom=$('[name="'+name+'"]'),this.config=_mix(_config,config),this.id=LP.guid();var t=this,o=this.config;switch(t.$tipDom=$(o.tipDom),_isCheckDom(t.$dom)&&(o.event="click"),o.event){case"input":t.$dom.bind("keyup",function(){t.valid(!0)});break;default:t.$dom.bind(o.event,function(){t.valid(!0)})}t.$dom.focus(function(){Validator.focusCallBack(t.$dom,t.$tipDom,o.focusMsg)})};Validator.prototype={valid:function(focus){var t=this,o=t.config,syncVal=function(){var loading=util.createLoading(t.$tipDom,"正在校验..."),syncArr=o.syncQueue||[],index=0;!function(){var callee=arguments.callee;index<syncArr.length&&(t.error===!0||!t.error)?syncArr[index].call(t,function(result){index++,t.error=result,callee()}):(loading.remove(),complete(!0))}()},complete=function(error){error===!1?error="校验失败":error===!0&&(error=""),t.error=error,t.status=2,t[error?"_validError":"_validSuccess"](),t.onComplete&&t.onComplete()},validRunning=function(){var val=function(){var dom=t.$dom.get(0),r="";if(!dom||"checkbox"!=dom.type&&"radio"!=dom.type)r=t.$dom.val();else{t.isCheckValue=!0;var tmp=[];t.$dom.each(function(i,item){item.checked?tmp.push(item.value):""}),r=tmp.join(",")}return r}();if((_isFunction(o.ignore)?o.ignore(val):o.ignore)&&(t.status=2),!val&&!o.requireMsg&&!o.requireCheckNum)return complete(!0);if(o.requireMsg&&!val)return complete(o.requireMsg);if(t.isCheckValue&&val.split(",").length<o.requireCheckNum)return complete(o.requireMsg||"必选"+o.requireCheckNum+"个");if(o.minLength||o.maxLength){var len=0;switch(o.lengthType){case"byte":len=util.length(val);break;case"word":len=util.length(val,!1)}if(o.minLength&&o.minLength>len)return complete(o.minLengthMsg||o.lengthMsg);if(o.maxLength&&o.maxLength<len)return complete(o.maxLengthMsg||o.lengthMsg)}$.each(o.regexps||[],function(i,arr){return(_isString(arr[0])?REGEXP[arr[0]](val):arr[0].test(val))===!!arr[2]?(complete(arr[1]),!1):void 0}),t.isComplete()||$.each(o.callBacks,function(i,fn){var result=fn.call(t,val);return _isString(result)&&result?(complete(result),!1):void 0}),t.isComplete()?complete(!0):syncVal()};return t.isComplete()&&!focus?this:(t.status=1,t.error="",o.delay?(clearTimeout(t.__timer),t.__timer=setTimeout(function(){validRunning()},o.delay)):validRunning(),this)},reset:function(){return this.status=0,this.error="",this.$tipDom.hide(),this},_validError:function(){return Validator.failureCallBack(this.$dom,this.$tipDom,this.error),this},_validSuccess:function(){return Validator.successCallBack(this.$dom,this.$tipDom,""),this},isRunning:function(){return 1==this.status},isStarted:function(){return 0!=this.status},isComplete:function(){return 2==this.status},isSuccess:function(){return!this.error},stop:function(){clearTimeout(this.__timer)},setDelay:function(time){return this.config.delay=time,this},setFocusMsg:function(msg){return this.config.focusMsg=msg,this},setTipDom:function(dom){return this.config.tipDom=dom,this.$tipDom=$(dom),this},setLength:function(min,max,msg){return this.config.maxLength=max,this.config.minLength=min,this.config.lengthMsg=msg,this},setLengthType:function(type){return this.config.lengthType=type,this},setMaxLength:function(num,msg){return this.config.maxLength=num,this.config.maxLengthMsg=msg,this},setMinLength:function(num,msg){return this.config.minLength=num,this.config.minLengthMsg=msg,this},setRequired:function(msg,checkNum){return this.config.requireMsg=msg,this.config.requireCheckNum=checkNum,this},setRegexp:function(reg,msg,eqvalue){return this.config.regexps.push([reg,msg,eqvalue]),this},setAjax:function(url,data,cb){var t=this,o=t.config;return o.syncQueue.push(function(asyncCB){$.ajax({url:url,data:$.extend(_isFunction(data)?data():data,function(){var d={};return d[t.name]=t.$dom.val(),d}()),dataType:"json",timeout:5e3,success:function(r){asyncCB(cb(r))},error:function(){asyncCB(!1)}})}),this},addSync:function(fn){return this.config.syncQueue.push(fn),this},addCallBack:function(fn){return this.config.callBacks.push(fn),this},setIgnore:function(fn){return this.config.ignore=fn,this},setComplete:function(fn){return this.onComplete=fn,this}};var FormValidator=function(){this.validators=[],this.statues={completeQueue:[],errorQueue:[],isCompleted:!0}};FormValidator.prototype={reset:function(){var t=this,st=t.statues;st.completeQueue=[],st.errorQueue=[],st.isCompleted=!1,$.each(t.validators,function(i,validator){validator.isComplete()&&(st.completeQueue.push(validator),validator.isSuccess()||st.errorQueue.push(validator))})},valid:function(success,failure){var t=this,st=t.statues;return st.isCompleted===!1?this:(t.success=success,t.failure=failure,t.reset(),st.completeQueue.length===t.validators.length&&t.complete(),t.runValidatorCallBack=!0,$.each(t.validators,function(i,validator){validator.valid()}),this)},add:function(validator){this.validators.push(validator);var t=this,st=t.statues;return validator.setComplete(function(){this.error&&st.errorQueue.indexOf(validator)<0&&st.errorQueue.push(validator),st.completeQueue.push(validator),t.runValidatorCallBack&&st.completeQueue.length==t.validators.length&&t.complete()}),this},complete:function(){var t=this,st=t.statues;if(t.runValidatorCallBack=!1,st.isCompleted=!0,st.errorQueue.length>0?t.failure&&t.failure():t.success&&t.success(),st.errorQueue.length){var $errors=$();$.each(st.errorQueue,function(i,val){$errors=$errors.add(val.$dom[0])}),util.error($errors)}}},Validator.successCallBack=function($dom,$tip){$tip.html('<span class="v-right"><i class="i-icon i-v-right"></i>&nbsp;</span>')},Validator.focusCallBack=function($dom,$tip,msg){$tip.html('<span class="v-msg">'+msg+"</span>")},Validator.failureCallBack=function($dom,$tip,msg){$tip.html('<span class="v-error"><i class="i-icon i-v-error"></i>'+msg+"</span>")},exports.formValidator=function(){return new FormValidator},exports.validator=function(name,cfg){return new Validator(name,cfg)},exports.setValidatorConfig=function(o){_mix(Validator,o,!0)}});